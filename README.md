# Danielle Randomizer

A simple randomizer for Prey 2017 (code-named "Danielle").

## Description

An external executable GUI that randomizes various entities in Prey 2017 by  overwriting the level files and generating a patch_randomizer.pak in GameSDK\Precache. Before overwriting, level files are backed up in the same directory as "level_backup.pak".

### Features

Here are some of the options the randomizer offers:

**Cosmetic**

* Randomized human appearance
* Randomized voice lines
* Randomized music
* Randomized player model

**Gameplay**

* Randomized item/physics prop spawns
* Randomized enemy/NPC spawns
* Randomized neuromod upgrade tree
* Randomized station connectivity

**Other features:**

* Start on 2nd day
* Add loot to Morgan's apartment
* Remove scan requirement for neuromods
* Unlock all doors/safes/workstations
* Get Off The Station mode (timed)
* Enable/disable gravity (experimental)

## Getting Started

**IMPORTANT if you want to avoid game crashes** If you plan to start a new randomized game in an existing save slot, manually delete the old save data first (and ensure cloud save doesn't try to restore it). By default this should be in `C:\Users\<Name>\Saved Games\Arkane Studios\Prey\SaveGames`. This is because unfortunately Prey does not always cleanly delete old files before starting up a new game. 

If you don't do this, there's a chance your old save files will stay there and conflict with the randomized level files. The same applies if you are done with this randomized save slot and want to use it for a normal game.

### Dependencies

* Requires a valid copy of Prey 2017 on Steam or GOG (the Windows Store version of Prey 2017 cannot be modded).
* Must have [Java for Windows](http://java.com/download) installed.

### Running the randomizer (as of v0.3)

1. Unzip danielle_randomizer.zip anywhere.
2. Ensure danielle_randomizer.exe is in the same directory as the included data.pak file and spawn_presets.json file.
3. Run danielle_randomizer.exe to start up the GUI.
4. Specify Prey install directory.
5. Specify desired randomization settings.
6. Click "Install" to generate randomized files and install them.
7. Start a new randomized game!

Once you have a game in progress, do not reinstall with a different seed or different settings. Loading a save file that was generated under a different seed can result in the game recognizing it as corrupt and "helpfully" deleting it for you.

When done with your randomized game, use the "Uninstall" button to revert any changes made by this randomizer. Note that once the mod is uninstalled, all save files created while the randomizer was in effect will become unplayable.

If the randomizer spends a long time at the "Installing..." step, check the generated log.txt file to see if it encountered any errors. Sometimes it can just take a long time to randomize the first time around.

### Uninstalling

* Ideally, use the "Uninstall" function within the randomizer GUI to remove any generated files.
* To manually unininstall the patch file generated by this mod, delete patch_randomizer.pak in Prey\GameSDK\Precache, if it exists.
* To manually uninstall the level files generated by this mod, go to Prey\GameSDK\Levels\Campaign in your game directory and replace every case of level.pak with level_backup.pak for each map, if level_backup.pak exists.
* If this isn't possible, you can use the GOG or Steam client to redownload any missing or modified files.
* To uninstall the randomizer itself, just delete danielle_randomizer.exe and its associated files.

## Description of presets

### Item spawn presets - Affects entities that are spawned directly in the level

* Randomize all - Randomizes all items and replaces them with new items at a (mostly) sane spawn rate. Should not affect items that are essential for story progress.
* Randomize all (chaotic)- Similar to randomize all, but has a chance of spawning story progression items (ex. the arming keys) early, as well as hazardous items such as explosive containers or radioactive containers.
* Randomize all (lite) - Objects are randomized within their type. Ex. weapons are replaced with other weapons, food is replaced with other food, fab plans are replaced with other fab plans, etc.

### NPC spawn presets - Affects entities that are spawned from an NPC spawner

* Randomize all - Randomizes all typhon and replaces them with new hostile NPCs at a (mostly) sane spawn rate. Should not affect enemies that are essential for story progression.
* Randomize all (chaotic) - Similar to randomize all, but has a chance of spawning unkillable entities such as tentacles and turrets.
* Randomize all (lite) - Swaps out enemies for an enemy of roughly the same difficulty level. Ex. Mimics and base phantoms can become other mimics/base phantoms.

### Other options

* Randomize NPC bodies - Scrambles body parts for every human NPC.
* Randomize voice lines - Shuffles voices lines by voice actor
* Start on 2nd day - Starts the game at the beginning of the 2nd day of the intro.
* Add loot to Morgan's apartment - Adds some starting loot to various containers in Morgan's apartment (nightstands on either side of the bed, three kitchen cabinets, refrigerator, large kitchen cabinet)
* More guns - Adds more guns to the loot table. Some exotic variants use typhon organs as ammo. Make sure not to recycle the organs by mistake!
* Unlock all neuromod scans - Removes research requirements for all typhon neuromods. You'll still have to purchase them via neuromods though!
* Randomize Neuromod upgrade tree - Scrambles the neuromod skill tree so that the order of unlocking every neuromod will be a little different.
* Unlock everything - Unlocks (almost) every door, airlock, workstation, safe, etc on board the station. Does not unlock the main lift or doors that are scripted to be locked (ex. the door to Psychotronics in the Lobby).
* Randomize station connections - Scrambles connections between maps. Basic checks are done to ensure that the game is still completable.
* Make humans wander - Alters human AI so that their idle behavior is to wander rather than stand in place. Intended to be used with "typhon to humans" option to add some realism.

### Configuring custom randomizer settings

If you'd like to tweak the preset spawn rates for items and enemies, you can specify them yourself in settings.json.

This randomizer has assigned multiple tags to every entity in the game (ex. weapons are "Weapons", food is "ArkFood", etc). To see a list of supported entities and tags, see tagstoentities.csv (shows the entities associated with each tag) and entitiestotags.csv (shows the tags generated for each entity).

The level randomizer in this project uses a list of "filters" to process the level files. A "filter" consists of five arrays:

* input_tags - if an entity matches one of these tags, randomize it
* output_tags - acceptable tags for items to come out of this filter (first a tag is chosen randomly from this list, then an entity matching that tag is chosen randomly)
* output_weights - int array of relative weights to assign to each output tags. Must have the same length as output_tags.
* do_not_touch_tags - if an entity matches one of these tags, do NOT randomize it. overrides input_tags.
* do_not_output_tags - do NOT output any items that match a tag in this list. overrides output_tags.

Filters are processed sequentially for each level entity. If an entity can be transformed by multiple filters, the first one will take precidence and the rest will be ignored.

If you change settings.json while the randomizer GUI is active, close and reopen the GUI to see your changes.

## Known issues

* If save files are not manually deleted before starting a new save slot, game can crash if old level files are left over from the previous save.
* Temporary directories will not be deleted if there was an issue during randomization/install. If these start to pile up, feel free to delete them manually.
* Game can occasionally crash when quitting to menu.

## Authors

Report issues to [/u/Shape_in_the_Glass](https://reddit.com/u/shape_in_the_glass).

## Version History

* 0.0
    * Early prototyping/testing
* 0.1
    * Bug fixes with settings, log files
    * Adjust presets
    * Add tooltips to GUI
* 0.2 (beta)
    * Fix bug with multiple custom filters
    * Adjust presets
    * Add neuromod randomization
    * Add station randomization
    * Add "start on 2nd day"
    * Add game token override support
    * Add save settings support
    * Add "new seed" support
* 0.2
	* Adjust station randomization to reduce unplayable scenarios
	* Adjust costs for randomized neuromods so that they are proportional to their attainment order
	* Remove station randomization dependency on "open talos"
	* Change "open talos" option to "unlock everything"
	* Update item/enemy spawn presets to have a "recommended", "chaotic", and "lite" option
	* Various minor bug fixes, refactors, and improvements
* 0.21
	* Quick fix for randomized station, where Shuttle Bay --> GUTS door was not getting properly setting
	* Added "More guns" option
* 0.22
  * Adjusted chaotic presets so that they crash the game less
  * Implemented better threading support for installer
  * Adjusted item quantities in containers to be more reasonable
  * Fixed exotic ammo not working for "More guns" option
  * Added randomization for Alex and Luka's appearance in "randomize bodies" option
  * Added version compatibility check to saved settings file
  * Added "Make humans wander" option
* 0.30
  * Overhauled GUI for better organization
  * Overhauled dependency retrieval to take up less hard drive space
  * Running installer now creates a "last_used_settings.json" file that reflects the last used settings
  * Renamed "settings.json" to "spawn_presets.json" to make naming more accurate
  * Added "G.O.T.S." timed mode
  * Added music, player model randomization
  * Added option to skip Jovan's death cutscene
  * Set "Randomize loot tables" as a default when randomizing items
  * Updated skip to 2nd day option to use JerryTerry's "Natural Day 2 Start" mod
  * Tweaked recommended/chaotic/lite presets for items/enemies to better match expectations for those tiers
  * Modified neuromod skill tree randomization to randomize within category
  * Modified station randomization to allow Psychotronics, Hardware Labs, and Crew Quarters to be randomized
  * Modified station randomization so that the mod overwrites certain books in Morgan's apartment and office with the new layout of the station
  * Modified station randomization and G.O.T.S. mode so that the player can walk through Apex kill walls
  * Fixed a case where some randomly generated stations were soft locks
  * Fixed a case where item spawn multiplers were still not very reasonable
  * Fixed randomization for containers (for real this time)

## Dependencies info

This project uses:
* Jackson for json parsing, which is licensed under the Apache license.
* JDOM for xml parsing, which is licensed under the JDOM license.
* Guava, which is licensed under the Apache license.
* JGraphT for graph visualization, which is dual-licensed under LGPL 2.1 and EPL 2.0.

## Acknowledgments

A big thanks to:

* JerryTerry for letting me use their "Natural Day 2 Start" mod!
* Fellow Prey modders such as Rosodude, jmx777, and coyote, who have helped me understand more about the file structure
* The brave adventrous souls who have helped me playtest and debug
* The Prey reddit and discord communities for being pretty swell and listening to my terrible ideas
* Arkane Studios for being cool folks who make cool games =]
